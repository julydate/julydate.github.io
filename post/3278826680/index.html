<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico"><link rel="icon" type="image/png" href="/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="author" content="七夏浅笑"><meta name="description" content="跨域问题自始至终都是前端比较头疼也是很基础的一个问题，在当下前后端分离的架构模式逐渐走向主流的情况下，更容易遇到。本文会通过请求和响应来讲讲分别需要处理哪些东西来允许 API 跨域。"><meta name="keywords" content="前端,cross-origin,web,API,跨域,CORS,CloudFlare,Workers,"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><title>前端跨域问题及解决方案 - 七夏浅笑</title><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css"><link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css"><link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css"><link rel="stylesheet" href="/lib/prettify/tranquil-heart.min.css"><link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css"><link rel="stylesheet" href="/css/main.css"><script src="/lib/jquery/jquery.min.js"></script><style type="text/css">.banner-bg{background-image:url(//julydate-1251438221.file.myqcloud.com/img/bg.jpg);background-position:center;background-repeat:repeat-y;background-size:cover;background-attachment:fixed}</style><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="七夏浅笑" type="application/atom+xml">
</head><body class="banner-bg"><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>七夏浅笑</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/">主页</a></li><li class="nav-item"><a class="nav-link" href="/archives/">归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/">分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a></li><li class="nav-item"><a class="nav-link" href="/links/">友链</a></li><li class="nav-item"><a class="nav-link" href="/about/">关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a></li></ul></div></div></nav><div class="view intro-2 rgba-black-slight" id="background"><div class="full-bg-img"><div class="mask flex-center"><div class="container text-center white-text fadeInUp"><span class="h2" id="subtitle"></span><br><p class="mt-3"><i class="far fa-calendar-alt"></i> <span class="post-date">2022-03-10&nbsp;|&nbsp;</span> <i class="far fa-chart-bar"></i> <span class="post-count">3.2k</span>字&nbsp;|&nbsp; <i class="far fa-clock"></i> <span class="post-count">13</span>分钟</p></div></div></div></div></header><main id="mainContent" class="rgba-black-slight"><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="py-5 z-depth-3" id="board"><div class="post-content mx-auto" id="post"><div class="markdown-body"><p>跨域问题自始至终都是前端比较头疼也是很基础的一个问题，在当下前后端分离的架构模式逐渐走向主流的情况下，更容易遇到。本文会通过请求和响应来讲讲分别需要处理哪些东西来允许 API 跨域。</p><span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近看了下 <a target="_blank" href="https://workers.cloudflare.com/" rel="external nofollow noreferrer noopener">CloudFlare Workers</a>，看到<a target="_blank" href="https://developers.cloudflare.com/workers/examples/" rel="external nofollow noreferrer noopener">官方示例</a>之后想到了可以用来解决一些 API 不允许跨域的问题，稍微尝试了下。所以这篇文章一开始本来是打算讲怎么利用 CloudFlare Workers 反向代理解决 API 跨域问题的，但是讲了不少关于跨域的事情，所以顺便总结了下前端跨域问题的解决办法及注意事项。</p><p><strong>另外，由于我并不是专门做 Web 前端开发的，所以文中可能有不少错误的地方，希望大佬们能指出~</strong></p><blockquote><p>Cloudflare Workers provides a <a target="_blank" href="https://www.cloudflare.com/learning/serverless/what-is-serverless/" rel="external nofollow noreferrer noopener">serverless</a> execution environment that allows you to create entirely new applications or augment existing ones without configuring or maintaining infrastructure.</p><p><em>CloudFlare Workers 提供了一个无服务器执行环境，允许您创建全新的应用程序或扩充现有应用程序，而无需配置或维护基础设施。</em></p></blockquote><p>其实 Serverless 平台有很多，这里选择了 CloudFlare 是因为我觉得它不仅免费而且稳定，而且网络也特别好（CF YYDS，到某些特别的地方除外）。</p><p>不过除了 CloudFlare 还有 Vercel 这个平台也相当不错，官网：<a target="_blank" href="https://vercel.com/" rel="external nofollow noreferrer noopener">https://vercel.com/</a></p><p>另外关于跨域的话还是建议看看 MDN 上面的文档，更加详细：<a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS" rel="external nofollow noreferrer noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS</a></p><blockquote><p><code>跨源资源共享</code> (<a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/CORS" rel="external nofollow noreferrer noopener">CORS</a>)（或通俗地译为跨域资源共享）是一种基于 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/HTTP" rel="external nofollow noreferrer noopener">HTTP</a> 头的机制，该机制通过允许服务器标示除了它自己以外的其它<a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Origin" rel="external nofollow noreferrer noopener">origin</a>（域，协议和端口），这样浏览器可以访问加载这些资源。跨源资源共享还通过一种机制来检查服务器是否会允许要发送的真实请求，该机制通过浏览器发起一个到服务器托管的跨源资源的”预检”请求。在预检中，浏览器发送的头中标示有HTTP方法和真实请求中会用到的头。</p></blockquote><p><em>——摘自《<a target="_blank" href="https://developer.mozilla.org/zh-CN/" rel="external nofollow noreferrer noopener">MDN Web Docs</a>》</em></p><h2 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h2><h3 id="Referer"><a href="#Referer" class="headerlink" title="Referer"></a>Referer</h3><blockquote><p><code>Referer</code> 请求头包含了当前请求页面的来源页面的地址，即表示当前页面是通过此来源页面里的链接进入的。服务端一般使用 <code>Referer</code> 请求头识别访问来源，可能会以此进行统计分析、日志记录以及缓存优化等。</p><p>需要注意的是 referer 实际上是 “referrer” 误拼写。参见 <a target="_blank" href="https://zh.wikipedia.org/wiki/HTTP_referer" rel="external nofollow noreferrer noopener">HTTP referer on Wikipedia</a> （HTTP referer 在维基百科上的条目）来获取更详细的信息。</p></blockquote><p>一般来说在一些防止你跨域请求的 API 都会限制一下 <code>Referer</code>，一般都是它那边调用到这个 API 的网址，通过 F12 查看网络流量就可以看见，APP 的话则需要抓包才能看见，还有一些 API 只允许空 <code>Referer</code>。</p><h3 id="Origin"><a href="#Origin" class="headerlink" title="Origin"></a>Origin</h3><blockquote><p>请求首部字段 <strong><code>Origin</code></strong> 指示了请求来自于哪个站点。该字段仅指示服务器名称，并不包含任何路径信息。该首部用于 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/CORS" rel="external nofollow noreferrer noopener">CORS</a> 请求或者 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST" rel="external nofollow noreferrer noopener"><code>POST</code></a> 请求。除了不包含路径信息，该字段与 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referer" rel="external nofollow noreferrer noopener"><code>Referer</code></a> 首部字段相似。</p></blockquote><p>跨域请求的根本就是说的跨资源（Origin）共享，这也是一切的开端，而此项的处理办法与 <code>Referer</code> 相同。</p><h3 id="Referrer-Policy"><a href="#Referrer-Policy" class="headerlink" title="Referrer-Policy"></a>Referrer-Policy</h3><blockquote><p><strong><code>Referrer-Policy</code></strong> 首部用来监管哪些访问来源信息——会在 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referer" rel="external nofollow noreferrer noopener"><code>Referer</code></a> 中发送——应该被包含在生成的请求当中。</p><p>注意 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Referer" rel="external nofollow noreferrer noopener"><code>Referer</code></a> 实际上是单词 “referrer” 的错误拼写。<code>Referrer-Policy</code> 这个首部并没有延续这个错误拼写。</p></blockquote><p>所以在需要空 <code>Referer</code> 的时候，在请求头里就需要把 <code>Referrer-Policy</code> 设置为 <code>no-referrer</code>。其它情况一般来说很少遇到要改这个的吧（大概）。</p><h2 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h2><p>影响跨域响应的主要是有下面几个 HTTP 响应头。</p><h3 id="Access-Control-Allow-Origin"><a href="#Access-Control-Allow-Origin" class="headerlink" title="Access-Control-Allow-Origin"></a>Access-Control-Allow-Origin</h3><blockquote><p>此响应头指定了该响应的资源是否被允许与给定的<a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Origin" rel="external nofollow noreferrer noopener">origin</a>共享。</p></blockquote><p>在不考虑安全性和盗链的情况下，我们一般把它的值设置成 <code>*</code>，而当我们需要使用下一项所说的凭据（Credentials）时，则必须要指定此项的值为请求来源。</p><h3 id="Access-Control-Allow-Credentials"><a href="#Access-Control-Allow-Credentials" class="headerlink" title="Access-Control-Allow-Credentials"></a>Access-Control-Allow-Credentials</h3><blockquote><p>此响应头表示是否可以将对请求的响应暴露给页面。返回true则可以，其他值均不可以。</p><p>Credentials可以是 cookies, authorization headers 或 TLS client certificates。</p><p>当作为对预检请求的响应的一部分时，这能表示是否真正的请求可以使用credentials。注意简单的<a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/GET" rel="external nofollow noreferrer noopener"><code>GET</code></a> 请求没有预检，所以若一个对资源的请求带了credentials，如果这个响应头没有随资源返回，响应就会被浏览器忽视，不会返回到web内容。</p></blockquote><p>所以当要用到凭据的时候我们会把它设置成 <code>true</code>，而不需要用到凭据的 API 则不能传送此响应头</p><h3 id="Access-Control-Allow-Headers"><a href="#Access-Control-Allow-Headers" class="headerlink" title="Access-Control-Allow-Headers"></a>Access-Control-Allow-Headers</h3><blockquote><p>响应首部 <strong><code>Access-Control-Allow-Headers</code></strong> 用于 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Preflight_request" rel="external nofollow noreferrer noopener">preflight request</a> （预检请求）中，列出了将会在正式请求的 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Headers" rel="external nofollow noreferrer noopener"><code>Access-Control-Request-Headers</code></a> 字段中出现的首部信息。</p><p>如果请求中含有 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Headers" rel="external nofollow noreferrer noopener"><code>Access-Control-Request-Headers</code></a> 字段，那么这个首部是必要的。</p></blockquote><p>可以看出我们只需要对预检请求（一般是 <code>OPTIONS</code> 请求方式）返回此响应头，所以它的值我们会先从请求头 <code>Access-Control-Request-Headers</code> 里面获取，如果获取不到才设置为 <code>*</code>。</p><h3 id="Access-Control-Allow-Methods"><a href="#Access-Control-Allow-Methods" class="headerlink" title="Access-Control-Allow-Methods"></a>Access-Control-Allow-Methods</h3><blockquote><p>响应首部 <strong><code>Access-Control-Allow-Methods</code></strong> 在对 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Preflight_request" rel="external nofollow noreferrer noopener">preflight request</a>.（预检请求）的应答中明确了客户端所要访问的资源允许使用的方法或方法列表。</p></blockquote><p>这个和上面的 <code>Access-Control-Allow-Headers</code> 类似，也是从对应的请求头 <code>Access-Control-Request-Method</code> 里面获取（别问为什么不是 Methods，<del>强迫症难受</del>），如果获取不到则设置为 <code>*</code>。</p><h3 id="Access-Control-Expose-Headers"><a href="#Access-Control-Expose-Headers" class="headerlink" title="Access-Control-Expose-Headers"></a>Access-Control-Expose-Headers</h3><blockquote><p>响应首部 <strong><code>Access-Control-Expose-Headers</code></strong> 列出了哪些首部可以作为响应的一部分暴露给外部。</p><p>默认情况下，只有七种 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/Simple_response_header" rel="external nofollow noreferrer noopener">simple response headers</a> （简单响应首部）可以暴露给外部：</p><ul><li><a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Cache-Control" rel="external nofollow noreferrer noopener"><code>Cache-Control</code></a></li><li><a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Language" rel="external nofollow noreferrer noopener"><code>Content-Language</code></a></li><li><a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Length" rel="external nofollow noreferrer noopener"><code>Content-Length</code></a></li><li><a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Type" rel="external nofollow noreferrer noopener"><code>Content-Type</code></a></li><li><a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Expires" rel="external nofollow noreferrer noopener"><code>Expires</code></a></li><li><a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Last-Modified" rel="external nofollow noreferrer noopener"><code>Last-Modified</code></a></li><li><a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Pragma" rel="external nofollow noreferrer noopener"><code>Pragma</code></a></li></ul><p>如果想要让客户端可以访问到其他的首部信息，可以将它们在 <code>Access-Control-Expose-Headers</code> 里面列出来。</p></blockquote><p>所以如果有必要的话，可以将此项的值设置为 <code>*</code>，或者是你需要用到的响应头。</p><h3 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a>Content-Type</h3><blockquote><p><strong><code>Content-Type</code></strong> 实体头部用于指示资源的MIME类型 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/MIME_type" rel="external nofollow noreferrer noopener">media type</a> 。</p><p>在响应中，Content-Type标头告诉客户端实际返回的内容的内容类型。</p></blockquote><p>在反向代理 API 的时候也要特别注意这个响应头，有的 API 返回的内容明明是 JSON，响应头却是 <code>text/plain</code>，有时会就出现一些意料之外的情况，而且对后面提到的预检请求也有影响，所以这个响应头也要注意一下，保证和返回的内容匹配。常用的比如 JSON 为 <code>application/json</code>。</p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><blockquote><p>在响应附带身份凭证的请求时：</p><ul><li>服务器不能将 <code>Access-Control-Allow-Origin</code> 的值设为通配符“<code>*</code>”，而应将其设置为特定的域，如：<code>Access-Control-Allow-Origin: https://example.com</code>。</li><li>服务器不能将 <code>Access-Control-Allow-Headers</code> 的值设为通配符“<code>*</code>”，而应将其设置为首部名称的列表，如：<code>Access-Control-Allow-Headers: X-PINGOTHER, Content-Type</code></li><li>服务器不能将 <code>Access-Control-Allow-Methods</code> 的值设为通配符“<code>*</code>”，而应将其设置为特定请求方法名称的列表，如：<code>Access-Control-Allow-Methods: POST, GET</code></li></ul></blockquote><h2 id="预检请求"><a href="#预检请求" class="headerlink" title="预检请求"></a>预检请求</h2><blockquote><p>一个 CORS 预检请求是用于检查服务器是否支持 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Glossary/CORS" rel="external nofollow noreferrer noopener">CORS</a> 即跨域资源共享。</p><p>它一般是用了以下几个 HTTP 请求首部的 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/OPTIONS" rel="external nofollow noreferrer noopener"><code>OPTIONS</code></a> 请求：<a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Method" rel="external nofollow noreferrer noopener"><code>Access-Control-Request-Method</code></a> 和 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Request-Headers" rel="external nofollow noreferrer noopener"><code>Access-Control-Request-Headers</code></a>，以及一个 <a target="_blank" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Origin" rel="external nofollow noreferrer noopener"><code>Origin</code></a> 首部。</p><p>当有必要的时候，浏览器会自动发出一个预检请求；所以在正常情况下，前端开发者不需要自己去发这样的请求。</p></blockquote><p>这个算是要特别注意的地方，如果服务端就没有正常响应预检请求，就会出现调试 API 一切正常，放在浏览器里面调用的时候还是报跨域请求错误的情况，因为浏览器在发送正式请求前会有一次预检请求。所以有时候在处理响应来使 API 能够被跨域请求的时候要单独对预检请求进行处理。</p><p>从上一部分响应头中我们已经可以看出，服务端要对 <code>OPTIONS</code> 请求方式正确的返回 <code>Access-Control-Allow-Headers</code> 和 <code>Access-Control-Allow-Methods</code> 这两个响应头。除此之外，还需要返回正确的 <code>Content-Type</code>，保证其值和正式请求里返回的值一样。</p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>这里拿 UptimeRobot 的 API 举例，使用 CloudFlare Workers 来进行反向代理。</p><p>不需要用到凭据（Credentials）的情况下：</p><pre><code class="typescript">async function handleRequest(request) &#123;
    const &#123; pathname, searchParams &#125; = new URL(request.url);
    const param = searchParams.toString() ? &quot;?&quot; + searchParams.toString() : &quot;&quot;;
    const requestHeaders = request.headers.get(&quot;Access-Control-Request-Headers&quot;);
    const requestMethod = request.headers.get(&quot;Access-Control-Request-Method&quot;);
    
    // 响应预检请求
    if (request.method == &quot;OPTIONS&quot;) &#123;
        return new Response(&#39;&#123;&quot;Access&quot;: &quot;OPTIONS&quot;&#125;&#39;, &#123;
            status: 200,
            headers: &#123;
                &quot;Access-Control-Allow-Origin&quot;: &quot;*&quot;,
                &quot;Access-Control-Allow-Headers&quot;: requestHeaders ? requestHeaders : &quot;*&quot;,
                &quot;Access-Control-Allow-Methods&quot;: requestMethod ? requestMethod : &quot;*&quot;,
                &quot;Access-Control-Expose-Headers&quot;: &quot;*&quot;,
                &quot;Content-Type&quot;: &quot;application/json&quot;
            &#125;
        &#125;);
    &#125;
    
    // 处理正式请求
    const newRequest = new Request(&quot;https://api.uptimerobot.com&quot; + pathname + param, request);
    // 请求头删除来源
    newRequest.headers.set(&quot;referrer-policy&quot;, &quot;no-referrer&quot;);
    newRequest.headers.delete(&quot;Referer&quot;);
    newRequest.headers.delete(&quot;Origin&quot;);
    // 发起请求
    const response = await fetch(newRequest);
    const newResponse = new Response(response.body, response);
    
    // 处理响应
    newResponse.headers.delete(&quot;Access-Control-Allow-Credentials&quot;);
    newResponse.headers.set(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
    newResponse.headers.set(&quot;Access-Control-Allow-Headers&quot;, requestHeaders ? requestHeaders : &quot;*&quot;);
    newResponse.headers.set(&quot;Access-Control-Allow-Methods&quot;, requestMethod ? requestMethod : &quot;*&quot;);
    newResponse.headers.set(&#39;Access-Control-Expose-Headers&#39;, &#39;*&#39;);
    newResponse.headers.set(&quot;Content-Type&quot;, &quot;application/json&quot;);
    return newResponse;
&#125;

addEventListener(&#39;fetch&#39;, event =&gt; &#123;
    event.respondWith(handleRequest(event.request));
&#125;)
</code></pre><p>而需要用到凭据（Credentials）的情况下：</p><pre><code class="typescript">async function handleRequest(request) &#123;
    const &#123; origin, pathname, searchParams &#125; = new URL(request.url);
    const param = searchParams.toString() ? &quot;?&quot; + searchParams.toString() : &quot;&quot;;
    const requestHeaders = request.headers.get(&quot;Access-Control-Request-Headers&quot;);
    const requestMethod = request.headers.get(&quot;Access-Control-Request-Method&quot;);
    const requestOrigin = request.headers.get(&quot;Origin&quot;) ? request.headers.get(&quot;Origin&quot;) : origin;
    
    // 响应预检请求
    if (request.method == &quot;OPTIONS&quot;) &#123;
        return new Response(&#39;&#123;&quot;Access&quot;: &quot;OPTIONS&quot;&#125;&#39;, &#123;
            status: 200,
            headers: &#123;
                &quot;Access-Control-Allow-Origin&quot;: requestOrigin ? requestOrigin : &quot;*&quot;,
                &quot;Access-Control-Allow-Credentials&quot;: &quot;true&quot;,
                &quot;Access-Control-Allow-Headers&quot;: requestHeaders ? requestHeaders : &quot;*&quot;,
                &quot;Access-Control-Allow-Methods&quot;: requestMethod ? requestMethod : &quot;*&quot;,
                &quot;Content-Type&quot;: &quot;application/json&quot;
            &#125;
        &#125;);
    &#125;
    
    // 处理正式请求
    const newRequest = new Request(&quot;https://api.uptimerobot.com&quot; + pathname + param, request);
    // 请求头删除来源
    newRequest.headers.set(&quot;referrer-policy&quot;, &quot;no-referrer&quot;);
    newRequest.headers.delete(&quot;Referer&quot;);
    newRequest.headers.delete(&quot;Origin&quot;);
    // 发起请求
    const response = await fetch(newRequest);
    const newResponse = new Response(response.body, response);
    
    // 处理响应
    newResponse.headers.set(&quot;Access-Control-Allow-Origin&quot;, requestOrigin ? requestOrigin : &quot;*&quot;);
    newResponse.headers.set(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;);
    newResponse.headers.set(&quot;Access-Control-Allow-Headers&quot;, requestHeaders ? requestHeaders : &quot;*&quot;);
    newResponse.headers.set(&quot;Access-Control-Allow-Methods&quot;, requestMethod ? requestMethod : &quot;*&quot;);
    newResponse.headers.set(&#39;Access-Control-Expose-Headers&#39;, &#39;*&#39;);
    newResponse.headers.set(&quot;Content-Type&quot;, &quot;application/json&quot;);
    return newResponse;
&#125;

addEventListener(&#39;fetch&#39;, event =&gt; &#123;
    event.respondWith(handleRequest(event.request));
&#125;)
</code></pre><p>除了 <code>Referer</code> 与 <code>Origin</code> 需要根据实际情况进行修改以外，基本上可以适配大部分 API 了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>关于跨域请求比较难的地方主要是带凭据（Credentials）的处理，在前后端分离的情况下，后端 Cookie 的写入也是一个比较棘手的问题，需要注意 Cookie 的生效范围与安全策略之类的，暂时不在本文的讨论范围内（<del>我不会</del>）。</p><p>对了上面拿 UptimeRobot 举例了，所以顺便提一下，关于 UptimeRobot 的完整反向代理可以看我哒这个项目：<a target="_blank" href="https://github.com/julydate/UptimeRobot-Proxy-Workers" rel="external nofollow noreferrer noopener">https://github.com/julydate/UptimeRobot-Proxy-Workers</a></p><p>然后也有别人的一些 CloudFlare Workers 反向代理方案，比如同样反向代理 UptimeRobot 的 <a target="_blank" href="https://github.com/yb/uptime-status" rel="external nofollow noreferrer noopener">uptime-status</a>，还有 <a target="_blank" href="https://github.com/mumuchenchen/pikpak/blob/main/cf-worker/index.js" rel="external nofollow noreferrer noopener">PikPak</a> 的，都可以参考参考。</p><p>最后提醒一个，有时候出现跨域请求错误并不一定是后端没有配置好允许跨域，可能是因为后端报错了（HTTP Code 4xx 或者 5xx 的情况），这个时候就需要仔细排查了，而不要被跨域请求报错带到坑里以为是跨域没有配置好（算是我以前遇到的坑坑之一吧）。</p><p>参考文档：《<a target="_blank" href="https://developer.mozilla.org/zh-CN/" rel="external nofollow noreferrer noopener">MDN Web Docs</a>》</p><hr></div><br><div><div id="post-tag"><span><i class="iconfont icon-inbox"></i> <a class="hover-with-bg" href="/categories/%E7%A8%8B%E5%BA%8F">程序</a> &nbsp; </span><span><i class="iconfont icon-tag"></i> <a class="hover-with-bg" href="/tags/%E5%89%8D%E7%AB%AF">前端</a> <a class="hover-with-bg" href="/tags/cross-origin">cross-origin</a> <a class="hover-with-bg" href="/tags/web">web</a> <a class="hover-with-bg" href="/tags/API">API</a> <a class="hover-with-bg" href="/tags/%E8%B7%A8%E5%9F%9F">跨域</a> <a class="hover-with-bg" href="/tags/CORS">CORS</a> <a class="hover-with-bg" href="/tags/CloudFlare">CloudFlare</a> <a class="hover-with-bg" href="/tags/Workers">Workers</a></span></div><div id="post-note"><div><strong>本文作者：</strong><a href="/">七夏浅笑</a></div><div><strong>本文链接：</strong><a href="https://www.julydate.com/post/3278826680/">https://www.julydate.com/post/3278826680/</a></div><div><strong>版权声明：</strong>本站文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/3.0/deed.zh" rel="nofollow noopener noopener">CC BY-NC-SA 3.0 CN</a> 协议进行许可</div></div><div id="post-nav" class="container"><div class="row"><a href="/post/1888545210/" id="post-nav-prev" class="col"><i class="fas fa-arrow-left"></i> <span class="post-nav-title">使用 acme.sh 申请 Google Cloud SSL 证书</span> </a><a href="/post/3500430050/" id="post-nav-next" class="col"><span class="post-nav-title">OBS 通过代理推流</span> <i class="fas fa-arrow-right"></i></a></div></div></div></div><div class="col-lg-10 mx-auto nopadding-md"><div class="comments mx-auto" id="comments"><br><br><link rel="stylesheet" href="/lib/waline/2.15.6/waline.min.css"><style type="text/css">.wl-[data-class=wl-] .wl-content>p>a:not(.at){overflow-wrap:anywhere;display:inline}</style><div id="vcomments" style="margin:0 auto"></div><script defer src="/lib/waline/2.15.6/waline.min.js"></script><script>var notify=!1,verify=!1,oldLoad=window.onload;window.onload=function(){function e(e){const t=new FormData;return t.append("image",e),t.append("apiType","catbox"),t.append("token","146faa57355f01c8eed8a045eda6a684"),fetch("//www.hualigs.cn/api/upload",{method:"POST",mode:"cors",body:t}).then(e=>e.json()).then((function(e){const t=new RegExp("^[a-zA-z]+://[^s]*");let a=e.data.url.catbox;return t.test(a)?a:e.data.url[2]}))}Waline.init({el:"#vcomments",serverURL:"https://waline.julydate.com",meta:["nick","mail","link"],pageSize:"10",emoji:["https://www.julydate.com/waline-emojis/alus","https://www.julydate.com/waline-emojis/qq","https://www.julydate.com/waline-emojis/bilibili"],locale:{placeholder:"说点什么吧quq",uploading:"上传中...默认图床在境内可能无法访问"},imageUploader:function(t){return function(t){const a=new FormData;return a.append("smfile",t),a.append("format","json"),fetch("https://smms.xhtml.love/upload",{method:"POST",mode:"cors",headers:new Headers({Authorization:"FNnpntzeJnw1SQc61jL6Tt1UZPzmhLBT"}),body:a}).then(e=>e.json()).then((function(a){const n=new RegExp("^[a-zA-z]+://[^s]*");let o="image_repeated"==a.code?a.images:a.data.url?a.data.url:"";return n.test(o)?o:e(t)})).catch((function(a){return e(t)}))}(t)}}),oldLoad&&oldLoad()}</script><noscript>Please enable JavaScript to view the <a target="_blank" href="https://waline.js.org" rel="nofollow noopener noopener">comments powered by Waline.</a></noscript></div></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container"><div id="toc"><p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p><div id="tocbot"></div></div></div></div></div></main><div id="sidebar" class="sidebar-hide"><span class="sidebar-button sidebar-button-shift" id="toggle-sidebar"><i class="fa fa-arrow-right on" aria-hidden="true"></i></span><div class="sidebar-overlay"></div><div class="sidebar-intrude"><div class="sidebar-avatar"><img src="//julydate-1251438221.file.myqcloud.com/img/head.jpg" srcset="//julydate-1251438221.file.myqcloud.com/img/head.jpg" alt="avatar"></div><div class="text-center sidebar-about"><p class="h3 sidebar-author">七夏浅笑</p><p class="sidebar-subtitle">七月之约，夏末浅笑<script type="text/javascript">console.log("博主认证: https://bbs.liyuans.com")</script></p><a href="https://github.com/julydate" class="h4" target="_blank"><i class="fab fa-github" aria-hidden="true"></i> </a>&nbsp;&nbsp; <a href="https://twitter.com/julydate" class="h4" target="_blank"><i class="fab fa-twitter" aria-hidden="true"></i> </a>&nbsp;&nbsp; <a href="https://live.bilibili.com/22628687" class="h4" target="_blank"><i class="fab fa-youtube" aria-hidden="true"></i> </a>&nbsp;&nbsp; <a href="mailto:i@xhtml.love" class="h4" target="_blank"><i class="fas fa-envelope" aria-hidden="true"></i> </a>&nbsp;&nbsp;</div><div class="sidebar-friend"><p class="h6 sidebar-friend-title"><span class="sidebar-label-left"><i class="fas fa-user-friends"></i></span> <span class="sidebar-label">友情链接</span></p><ul class="list-group"><a href="/links/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 其余友链在内页</li></a><a href="https://xiaopc.org/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; xiaopc</li></a><a href="https://webdoger.me/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 孔壕</li></a><a href="https://diygod.me/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; DIYgod</li></a><a href="https://www.chinuno.com/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 兔兔</li></a><a href="https://tea9.xyz/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 茶姐姐</li></a><a href="https://qianling.pw/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 千灵夙赋</li></a><a href="https://moegod.com/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 月宅</li></a><a href="https://www.xytsing.com/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 咸鱼滩音乐团队</li></a><a href="https://hitokoto.cn/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 一言</li></a><a href="https://blog.naixi.net/" target="_blank"><li class="list-group-item"><i class="fas fa-quote-left"></i>&nbsp; 奶昔</li></a></ul></div></div></div><a class="z-depth-1" id="scroll-top-button" href="#" role="button"><i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><div id="footerContent" class="rgba-black-slight"><footer class="pt-5"><div class="text-center py-3"><div class="footer-theme"><a href="https://hexo.io" target="_blank" rel="nofollow noopener noreferrer">Hexo</a> theme <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener noreferrer">Fluid</a> mod by <a href="https://github.com/qixa/hexo-theme-fluid-mod" target="_blank" rel="nofollow noopener noreferrer">Julydate</a></div><div class="footer-copyright">©2026&nbsp;七夏浅笑 <i class="iconfont icon-love"></i> <span>萌萌哒<span id="runtime"></span>天啦</span></div><div class="footer-hitokoto"><a id="hitokotoa" href="#" target="_blank" rel="nofollow noopener noreferrer"><span id="hitokoto"></span></a></div></div></footer></div><script src="/lib/popper/popper.min.js"></script><script src="/lib/bootstrap/js/bootstrap.min.js"></script><script src="/lib/mdbootstrap/js/mdb.min.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script src="/lib/tocbot/tocbot.min.js"></script><script src="/js/post.js"></script><script src="/lib/prettify/prettify.min.js"></script><script type="text/javascript">$(document).ready((function(){$("pre").addClass("prettyprint  linenums"),prettyPrint()}))</script><script src="/lib/typed/typed.min.js"></script><script type="text/javascript">var typed=new Typed("#subtitle",{strings:["  ","前端跨域问题及解决方案&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready((function(){$(".typed-cursor").addClass("h2"),typed.start()}))</script><script src="/lib/anchor/anchor.min.js"></script><script type="text/javascript">anchors.options={placement:"right",visible:"hover"};var el="h1,h2,h3,h4,h5,h6".split(","),res=[];for(item of el)res.push(".markdown-body > "+item);anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script type="text/javascript">var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){getSearchFile(path),this.onclick=null}</script><script src="/lib/fancybox/jquery.fancybox.min.js"></script><script type="text/javascript">var setupFancybox=function(){$("#post img:not(.no-zoom img, img[no-zoom])").each((function(){var t=document.createElement("a");$(t).attr("data-fancybox","gallery"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)}))};setupFancybox()</script><script type="text/javascript">function hitokoto(o){$("#hitokoto").stop().fadeOut((function(){$("#hitokoto").html(o.hitokoto),document.getElementById("hitokotoa").href="https://hitokoto.cn/?uuid="+o.uuid,$("#hitokoto").stop().fadeIn()}))}function getHitokoto(){var o=["a","b","c","d","e","i"];fetch("https://v1.hitokoto.cn/?encode=json&charset=utf-8&c="+o[Math.floor(Math.random()*o.length)],{cache:"no-cache",method:"GET",mode:"cors"}).then(o=>o.json()).then(o=>{hitokoto(o),setTimeout(getHitokoto,1e4)}).catch(console.error)}$(document).ready((function(){getHitokoto()}))</script><script type="text/javascript">$("#background").removeClass("banner-bg"),$("body").addClass("banner-bg");var postToTopHight=$("#board").offset().top;$(window).scroll((function(){document.body.scrollTop+document.documentElement.scrollTop>=postToTopHight?($("#background").removeClass("rgba-black-slight"),$("#mainContent").removeClass("rgba-black-slight"),$("#footerContent").removeClass("rgba-black-slight")):($("#background").addClass("rgba-black-slight"),$("#mainContent").addClass("rgba-black-slight"),$("#footerContent").addClass("rgba-black-slight"))}))</script><script type="text/javascript">var blogRunTime=function(){var e=document.getElementById("runtime"),n=new Date("2015,04,20"),t=(new Date).getTime()-n.getTime(),i=Math.floor(t/864e5);e.innerHTML=i};$(document).ready((function(){blogRunTime()}))</script><script type="text/javascript">var originalTitle=document.title;window.onblur=function(){document.title="你不爱我了QAQ"},window.onfocus=function(){document.title=originalTitle}</script><script type="text/javascript">var jumpComments=function(){if(window.location.hash){var n=decodeURI(window.location.hash);if(!$(n).length)var o=setInterval((function(){$(n).length&&(clearInterval(o),setTimeout((function(){$("html, body").animate({scrollTop:$(n).offset().top-90},1e3)}),1500))}),100)}};$(document).ready((function(){jumpComments()}))</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-150991779-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-150991779-1")</script></body></html>